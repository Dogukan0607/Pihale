<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emlak Haritasƒ± (Supabase)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background-color: #2c3e50;
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
      flex-grow: 1;
      text-align: center;
    }

    #menuToggle {
      background:none; border:none; cursor:pointer; display:flex;
      flex-direction: column; justify-content:center; gap:5px; padding:8px;
    }
    #menuToggle span { display:block; height:3px; background:#fff; border-radius:2px; width:25px; }

    .profile-menu { position: relative; }
    .profile-icon {
      background-color: #000; border: none; color: white; font-size: 16px;
      border-radius: 50%; width: 36px; height: 36px; cursor: pointer;
    }
    .dropdown-menu {
      position: absolute; top: 45px; right: 0; background: white;
      border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none; flex-direction: column; min-width: 150px; z-index: 1000;
    }
    .dropdown-menu button {
      padding: 10px 14px; background: none; border: none; text-align: left;
      font-size: 14px; cursor: pointer; border-bottom: 1px solid #eee;
    }
    .dropdown-menu button:hover { background-color: #f0f0f0; }

    #sideMenu {
      position: fixed; top: 0; left: -250px; width: 250px; height: 100%;
      background: #2c3e50; padding: 20px; box-sizing: border-box;
      transition: left 0.3s ease; color: white; z-index: 2000;
    }
    #sideMenu ul { list-style:none; padding:0; }
    #sideMenu ul li { margin-bottom: 15px; transition: transform 0.2s ease; }
    #sideMenu ul li:hover { transform: scale(1.05); }
    #sideMenu ul li a { color:white; text-decoration:none; font-size: 16px; display:block; }

    #filters {
      background: #ecf0f1;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    select, button, input[type="number"], input[type="text"] {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
      transition: all 0.2s ease-in-out;
    }
    button:hover, select:hover, input:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    #map { flex: 1; width: 100%; }

    .dot-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .dot-marker:hover {
      transform: scale(1.4);
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
    }

    .leaflet-popup-content { margin:0; padding:0; }
    .popup-card {
      display: flex;
      flex-direction: row;
      width: 280px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .popup-card:hover { transform: scale(1.03); }
    .popup-card img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }
    .popup-info {
      flex: 1;
      padding: 8px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .popup-info strong {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
    }
    .popup-info .details {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .popup-info .price {
      margin-top: 5px;
      font-size: 14px;
      color: #2c3e50;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      #filters {
        flex-direction: column;
        align-items: stretch;
      }
      .popup-card {
        flex-direction: column;
        width: 220px;
      }
      .popup-card img {
        width: 100%;
        height: 140px;
      }
      header h1 {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>

<header>
  <button id="menuToggle" aria-label="Men√ºy√º A√ß/Kapat">
    <span></span>
    <span></span>
  </button>
  
  <h1>Pƒ∞HALE Harita Uygulamasƒ±</h1>
  
  <div class="profile-menu">
    <button class="profile-icon" id="profileBtn">üë§</button>
    <div class="dropdown-menu" id="profileMenu">
      <button onclick="window.location.href='profil.html'">Profilim</button>
      <button onclick="window.location.href='analiz.html'">Analiz</button>
      <button onclick="window.location.href='ilanlarim.html'">ƒ∞lanlarƒ±m</button>
      <button onclick="window.location.href='ayarlar.html'">Ayarlar</button>
      <button onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
    </div>
  </div>
</header>

<nav id="sideMenu">
  <h2>Men√º</h2>
  <ul>
    <li><a href="hizlisatis.html">Hƒ±zlƒ± ƒ∞hale</a></li>
    <li><a href="sutun.html?tur=konut">Konut</a></li>
    <li><a href="sutun.html?tur=isyeri">ƒ∞≈ü Yeri</a></li>
    <li><a href="sutun.html?tur=arsa">Arsa</a></li>
    <li><a href="sutun.html?tur=konutProjesi">Konut Projeleri</a></li>
    <li><a href="sutun.html?tur=bina">Bina</a></li>
    <li><a href="sutun.html?tur=devremulk">Devre M√ºlk</a></li>
    <li><a href="sutun.html?tur=turistik">Turistlik Tesis</a></li>
    <li><a href="Sayfa-1.html">Hakkƒ±mƒ±zda</a></li>
  </ul>
</nav>

<div id="filters">
  <input type="text" id="title-filter" placeholder="Ba≈ülƒ±k Ara" />
  <select id="status-filter">
    <option value="">Durum</option>
    <option value="satƒ±lƒ±k">Satƒ±lƒ±k</option>
    <option value="kiralƒ±k">Kiralƒ±k</option>
  </select>
  <select id="il-filter"><option value="">ƒ∞l</option></select>
  <select id="ilce-filter"><option value="">ƒ∞l√ße</option></select>
  <input type="number" id="oda-min" placeholder="Min Oda" />
  <input type="number" id="oda-max" placeholder="Max Oda" />
  <input type="number" id="m2-min" placeholder="Min m¬≤" />
  <input type="number" id="m2-max" placeholder="Max m¬≤" />
  <button onclick="applyFilters()">Filtrele</button>
</div>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const supabaseUrl = "https://ofmupldxmqtgddzvbakp.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbXVwbGR4bXF0Z2RkenZiYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MzU5OTksImV4cCI6MjA2OTIxMTk5OX0.TrMgsB37M12xT84UIvkIAzG285SpaKUjDAXn5GBMFsA"; // kendi anahtarƒ±nƒ± koy
const supabaseClient = createClient(supabaseUrl, supabaseKey);

const map = L.map('map', {
  zoomControl: false,
  minZoom: 6,
  maxZoom: 18,
  maxBounds: [
    [35.8086, 25.0],
    [42.1, 45.0]
  ],
  maxBoundsViscosity: 1.0
}).setView([39.0, 35.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap katkƒ±cƒ±larƒ±'
}).addTo(map);

const markersGroup = L.markerClusterGroup();
map.addLayer(markersGroup);

function addMarker(ilan) {
  let konum = ilan.konum;
  if (typeof konum === "string") {
    try { konum = JSON.parse(konum); } catch (e) { return; }
  }
  if (!konum || !konum.lat || !konum.lng) return;

  const renk = (ilan.durum || "").toLowerCase() === "satƒ±lƒ±k" ? "#e67e22" : "#27ae60";

  const customIcon = L.divIcon({
    className: "custom-dot",
    html: `<div class="dot-marker" style="background:${renk}"></div>`,
    iconSize: [16, 16],
    iconAnchor: [8, 8]
  });

  let detay = ilan.detaylar || {};
  if (typeof detay === "string") {
    try { detay = JSON.parse(detay); } catch (e) { detay = {}; }
  }

  let resimler = ilan.resimler || [];
  if (typeof resimler === "string") {
    try { resimler = JSON.parse(resimler); } catch (e) { resimler = []; }
  }
  const ilkResim = resimler.length > 0 ? resimler[0] : 'https://via.placeholder.com/100';

  const odaSayisi = detay.oda_sayisi || detay.odaSayisi || "-";
  const kat = detay.kat || "-";
  const m2Brut = detay.m2_brut || detay.m2Brut || "-";

  const marker = L.marker([konum.lat, konum.lng], { icon: customIcon });

  marker.bindPopup(`
    <div class="popup-card" onclick="window.location.href='ilan-detay.html?id=${ilan.id}'">
      <img src="${ilkResim}" alt="ƒ∞lan Resmi" />
      <div class="popup-info">
        <strong>${ilan.title || 'Ba≈ülƒ±k Yok'}</strong>
        <div class="details">üìç ${ilan.ilce || '-'}, ${ilan.il || '-'}</div>
        <div class="details">üìè ${m2Brut} m¬≤ ‚Ä¢ üõè ${odaSayisi} ‚Ä¢ üè¢ ${kat}</div>
        <div class="details">Durum: ${(ilan.durum || '-').toUpperCase()}</div>
        <div class="price">${ilan.price ? ilan.price + ' TL' : 'Fiyat Yok'}</div>
      </div>
    </div>
  `);

  markersGroup.addLayer(marker);
}

async function loadListings() {
  const { data, error } = await supabaseClient
    .from('ilanlar')
    .select('*')
    .eq('onay_durumu', 'onaylandi');

  if (error) {
    console.error("ƒ∞lanlar y√ºklenemedi:", error.message);
    return;
  }

  window.allListings = data || [];
  markersGroup.clearLayers();
  window.allListings.forEach(addMarker);
}

async function loadFilters() {
  const { data, error } = await supabaseClient
    .from('ilanlar')
    .select('il, ilce')
    .eq('onay_durumu', 'onaylandi');

  if (error) {
    console.error("Filtre verileri alƒ±namadƒ±:", error.message);
    return;
  }

  const iller = [...new Set(data.map(item => item.il).filter(Boolean))];
  const ilSelect = document.getElementById('il-filter');
  iller.forEach(il => {
    const opt = document.createElement('option');
    opt.value = il;
    opt.textContent = il;
    ilSelect.appendChild(opt);
  });

  ilSelect.addEventListener('change', () => {
    const secilenIl = ilSelect.value;
    const ilceSelect = document.getElementById('ilce-filter');
    ilceSelect.innerHTML = '<option value="">ƒ∞l√ße</option>';

    data.filter(item => item.il === secilenIl).forEach(item => {
      if (item.ilce) {
        const opt = document.createElement('option');
        opt.value = item.ilce;
        opt.textContent = item.ilce;
        ilceSelect.appendChild(opt);
      }
    });
  });
}

function applyFilters() {
  const title = document.getElementById('title-filter').value.toLowerCase();
  const durum = document.getElementById('status-filter').value;
  const il = document.getElementById('il-filter').value;
  const ilce = document.getElementById('ilce-filter').value;
  const odaMin = parseInt(document.getElementById('oda-min').value) || 0;
  const odaMax = parseInt(document.getElementById('oda-max').value) || 999;
  const m2Min = parseInt(document.getElementById('m2-min').value) || 0;
  const m2Max = parseInt(document.getElementById('m2-max').value) || 9999;

  const filtered = window.allListings.filter(item => {
    let detay = item.detaylar;
    if (typeof detay === "string") {
      try { detay = JSON.parse(detay); } catch { detay = {}; }
    }

    const odaSayisi = parseInt(detay.oda_sayisi || detay.odaSayisi || 0);
    const m2Brut = parseInt(detay.m2_brut || detay.m2Brut || 0);

    return (
      (!title || (item.title && item.title.toLowerCase().includes(title))) &&
      (!durum || item.durum === durum) &&
      (!il || item.il === il) &&
      (!ilce || item.ilce === ilce) &&
      (odaSayisi >= odaMin && odaSayisi <= odaMax) &&
      (m2Brut >= m2Min && m2Brut <= m2Max)
    );
  });

  markersGroup.clearLayers();
  filtered.forEach(addMarker);
}

document.addEventListener("DOMContentLoaded", () => {
  const menuToggle = document.getElementById('menuToggle');
  const sideMenu = document.getElementById('sideMenu');
  const profileBtn = document.getElementById('profileBtn');
  const profileMenu = document.getElementById('profileMenu');

  menuToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    sideMenu.style.left = (sideMenu.style.left === '0px') ? '-250px' : '0px';
  });

  document.addEventListener('click', (e) => {
    if (!sideMenu.contains(e.target) && sideMenu.style.left === '0px') {
      sideMenu.style.left = '-250px';
    }
  });

  profileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    profileMenu.style.display = profileMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  document.addEventListener('click', () => {
    profileMenu.style.display = 'none';
  });
});

async function logout() {
  await supabaseClient.auth.signOut();
  localStorage.clear();
  alert("√áƒ±kƒ±≈ü yapƒ±lƒ±yor...");
  window.location.href = "giris.html";
}

loadListings();
loadFilters();
</script>

</body>
</html>