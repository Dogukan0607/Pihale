<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PiHALE İlanlar</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Üst Bar */
    .navbar {
      background-color: #2c3e50;
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .navbar h1 {
      font-size: 20px;
      margin: 0;
    }

    /* Tür Butonları */
    .tur-buttons {
      display: flex;
      gap: 10px;
      margin-left: 20px;
    }

    .tur-buttons a {
      background: #3498db;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      transition: 0.2s;
    }

    .tur-buttons a:hover {
      background: #2980b9;
      transform: scale(1.05);
    }

    /* Filtre Bar */
    .filters {
      display: flex;
      gap: 10px;
      padding: 10px;
      background-color: #ecf0f1;
      flex-wrap: wrap;
      justify-content: center;
    }

    .filters input,
    .filters select,
    .filters button {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      min-width: 90px;
      flex: 0 0 auto;
    }

    .filters button {
  background: #3498db;
  color: white;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.filters button:hover {
  background: #2980b9;
  transform: scale(1.05);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
}


    /* İlan Grid Alanı */
    .ilan-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }

    /* Kartlar */
.ilan-card {
  background: #2c3e50;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  height: 280px; 
}

.ilan-card:hover {
  transform: scale(1.03);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.ilan-card img {
  width: 100%;
  height: 160px; 
  object-fit: cover;
}

.ilan-info {
  flex: 1;
  padding: 10px;
  color: #fff;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: left;
  overflow: hidden;
}

.ilan-info h3 {
  margin: 0 0 5px;
  font-size: 18px;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.ilan-info p {
  margin: 2px 0;
  font-size: 14px;
  color: #ddd;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


    .ilan-info p strong {
      color: #fff;
    }

    @media (max-width: 900px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
      .tur-buttons {
        flex-wrap: wrap;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- Üst Navbar -->
  <div class="navbar">
    <h1>PiHALE İlanlar</h1>
    <!-- Tür Butonları -->
    <div class="tur-buttons">
      <a href="ilanlar.html?tur=konut">Konut</a>
      <a href="ilanlar.html?tur=arsa">Arsa</a>
      <a href="ilanlar.html?tur=bina">Bina</a>
    </div>
  </div>

  <!-- Filtre Alanı -->
  <div class="filters">
    <input type="text" id="searchTitle" placeholder="Başlık Ara">
    <select id="durum">
      <option value="">Durum</option>
      <option value="satilik">Satılık</option>
      <option value="kiralik">Kiralık</option>
    </select>
    <select id="il">
      <option value="">İl</option>
      <option value="Antalya">Antalya</option>
      <option value="Konya">Konya</option>
      <option value="Gaziantep">Gaziantep</option>
    </select>
    <select id="ilce">
      <option value="">İlçe</option>
    </select>
    <input type="number" id="minOda" placeholder="Min Oda">
    <input type="number" id="maxOda" placeholder="Max Oda">
    <input type="number" id="minM2" placeholder="Min m²">
    <input type="number" id="maxM2" placeholder="Max m²">
    <input type="number" id="minFiyat" placeholder="Min Fiyat">
    <input type="number" id="maxFiyat" placeholder="Max Fiyat">

    <!-- Sıralama -->
    <select id="sirala">
      <option value="">Sırala</option>
      <option value="fiyatArtan">Fiyat Artan</option>
      <option value="fiyatAzalan">Fiyat Azalan</option>
      <option value="m2Artan">m² Artan</option>
      <option value="m2Azalan">m² Azalan</option>
    </select>

    <button onclick="filtrele()">Filtrele</button>
  </div>

  <!-- İlan Kartları -->
  <div class="ilan-container" id="ilanListesi"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://ofmupldxmqtgddzvbakp.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbXVwbGR4bXF0Z2RkenZiYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MzU5OTksImV4cCI6MjA2OTIxMTk5OX0.TrMgsB37M12xT84UIvkIAzG285SpaKUjDAXn5GBMFsA"; // kendi key’inizi ekleyin
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let ilanlar = [];

    // İlçe listesi
    const ilceler = {
      Antalya: ["Akseki", "Alanya", "Finike", "Manavgat", "Konyaaltı"],
      Konya: ["Beyşehir", "Bozkır", "Seydişehir", "Meram", "Selçuklu"],
      Gaziantep: ["Şahinbey", "Şehitkamil", "Nizip", "Araban"]
    };

    document.getElementById("il").addEventListener("change", function () {
      const secilenIl = this.value;
      const ilceSelect = document.getElementById("ilce");
      ilceSelect.innerHTML = `<option value="">İlçe</option>`;
      if (ilceler[secilenIl]) {
        ilceler[secilenIl].forEach(ilce => {
          const opt = document.createElement("option");
          opt.value = ilce;
          opt.textContent = ilce;
          ilceSelect.appendChild(opt);
        });
      }
    });

    // İlanları getir (tur parametresine göre)
    async function ilanlariGetir() {
      const tur = new URLSearchParams(window.location.search).get('tur') || '';

      let query = supabaseClient
        .from("ilanlar")
        .select("*")
        .eq("onay_durumu", "onaylandi");

      if (tur) {
        query = query.eq("ilan_turu", tur);
      }

      const { data, error } = await query;

      if (error) {
        document.getElementById("ilanListesi").innerHTML = `<p>Hata: ${error.message}</p>`;
        return;
      }

      ilanlar = data || [];
      renderIlanlar(ilanlar);
    }

    // İlanları render et
    function renderIlanlar(data) {
      const container = document.getElementById("ilanListesi");
      container.innerHTML = "";

      if (data.length === 0) {
        container.innerHTML = "<p>İlan bulunamadı.</p>";
        return;
      }

      data.forEach(ilan => {
        let detay = ilan.detaylar || {};
        if (typeof detay === "string") {
          try { detay = JSON.parse(detay); } catch (e) { detay = {}; }
        }

        const odaSayisi = detay.odaSayisi || "-";
        const m2 = detay.m2Net || detay.m2Brut || "-";
        const il = ilan.il || "-";
        const ilce = ilan.ilce || "-";

        const div = document.createElement("div");
        div.className = "ilan-card";
        div.onclick = () => window.location.href = `ilan-detay.html?id=${ilan.id}`;

        div.innerHTML = `
          <img src="${ilan.resimler && ilan.resimler.length > 0 ? ilan.resimler[0] : 'https://via.placeholder.com/280x160'}" alt="${ilan.title}">
          <div class="ilan-info">
            <h3>${ilan.title}</h3>
            <p><strong>Fiyat:</strong> ${ilan.price} TL</p>
            <p><strong>Oda:</strong> ${odaSayisi} | <strong>m²:</strong> ${m2}</p>
            <p><strong>Konum:</strong> ${il} / ${ilce}</p>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Filtreleme + Sıralama
    function filtrele() {
      const baslik = document.getElementById("searchTitle").value.toLowerCase();
      const durum = document.getElementById("durum").value;
      const il = document.getElementById("il").value;
      const ilce = document.getElementById("ilce").value;
      const minOda = parseInt(document.getElementById("minOda").value) || 0;
      const maxOda = parseInt(document.getElementById("maxOda").value) || Infinity;
      const minM2 = parseInt(document.getElementById("minM2").value) || 0;
      const maxM2 = parseInt(document.getElementById("maxM2").value) || Infinity;
      const minFiyat = parseInt(document.getElementById("minFiyat").value) || 0;
      const maxFiyat = parseInt(document.getElementById("maxFiyat").value) || Infinity;
      const sirala = document.getElementById("sirala").value;

      let filtreli = ilanlar.filter(ilan => {
        const detay = typeof ilan.detaylar === "string" ? JSON.parse(ilan.detaylar) : ilan.detaylar || {};
        const oda = parseInt(detay.odaSayisi) || 0;
        const metre = parseInt(detay.m2Net || detay.m2Brut || 0);

        const matchBaslik = baslik ? ilan.title.toLowerCase().includes(baslik) : true;
        const matchDurum = durum ? ilan.durum === durum : true;
        const matchIl = il ? ilan.il === il : true;
        const matchIlce = ilce ? ilan.ilce === ilce : true;
        const matchOda = oda >= minOda && oda <= maxOda;
        const matchM2 = metre >= minM2 && metre <= maxM2;
        const matchFiyat = ilan.price >= minFiyat && ilan.price <= maxFiyat;

        return matchBaslik && matchDurum && matchIl && matchIlce && matchOda && matchM2 && matchFiyat;
      });

      // Sıralama
      if (sirala) {
        filtreli.sort((a, b) => {
          let detayA = typeof a.detaylar === "string" ? JSON.parse(a.detaylar) : a.detaylar || {};
          let detayB = typeof b.detaylar === "string" ? JSON.parse(b.detaylar) : b.detaylar || {};
          const m2A = parseInt(detayA.m2Net || detayA.m2Brut || 0);
          const m2B = parseInt(detayB.m2Net || detayB.m2Brut || 0);

          switch (sirala) {
            case "fiyatArtan": return a.price - b.price;
            case "fiyatAzalan": return b.price - a.price;
            case "m2Artan": return m2A - m2B;
            case "m2Azalan": return m2B - m2A;
            default: return 0;
          }
        });
      }

      renderIlanlar(filtreli);
    }

    ilanlariGetir();
  </script>
 <script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabase = createClient('https://ofmupldxmqtgddzvbakp.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbXVwbGR4bXF0Z2RkenZiYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MzU5OTksImV4cCI6MjA2OTIxMTk5OX0.TrMgsB37M12xT84UIvkIAzG285SpaKUjDAXn5GBMFsA');

// İyzico ödeme linkin
const paymentLink = "https://iyzi.link/AKNyxA";

async function girisKontrolu() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "giris.html"; 
    return;
  }

  // Kullanıcının kayıt tarihi ve ödeme durumunu çek
  const { data, error } = await supabase
    .from('kullanicilar')
    .select('created_at, subscription_status')
    .eq('id', user.id)
    .single();

  if (error) {
    console.error('Veri alınamadı:', error.message);
    return;
  }

  const kayitTarihi = new Date(data.created_at);
  const bugun = new Date();
  const farkGun = Math.floor((bugun - kayitTarihi) / (1000 * 60 * 60 * 24));

  // 30 günü geçtiyse ve subscription_status aktif değilse
  if (farkGun >= 30 && data.subscription_status !== 'active') {
    window.location.href = paymentLink;
  }
}

girisKontrolu();
</script>

</body>
</html>
