<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>İlanlar</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f5f5f5;
    }

    /* Sol Filtre Paneli */
    .filter-panel {
      width: 220px;
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
    }

    .filter-panel h2 {
      margin: 0 0 15px;
      font-size: 20px;
      border-bottom: 1px solid #fff;
      padding-bottom: 5px;
      text-transform: capitalize;
    }

    .filter-panel label {
      font-size: 14px;
      margin-top: 10px;
      display: block;
    }

    .filter-panel input,
    .filter-panel select,
    .filter-panel button {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 14px;
      margin-top: 5px;
    }

    .filter-panel button {
      background: #3498db;
      color: #fff;
      cursor: pointer;
      margin-top: 15px;
    }

    .filter-panel button:hover {
      background: #2980b9;
    }

    /* İlan Listesi */
    .ilan-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: flex-start;
    }

    .ilan-card {
      background: #2c3e50;
      display: flex;
      border-radius: 20px;
      box-shadow: 0 2px 6px rgba(235, 232, 232, 0.993);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      height: 150px;
      width: 300px;
    }

    .ilan-card:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 10px rgba(255, 251, 251, 0.2);
    }

    .ilan-card img {
      width: 120px;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0;
    }

    .ilan-info {
      padding: 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .ilan-info h3 {
      margin: 0 0 5px;
      font-size: 18px;
      color: #fcfcfc;
    }

    .ilan-info p {
      margin: 3px 0;
      font-size: 14px;
      color: #fffdfd;
    }

    .ilan-info p strong {
      color: #fff8f8;
    }

    /* Mobil uyum */
    @media (max-width: 900px) {
      body { flex-direction: column; }
      .filter-panel { width: 100%; flex-direction: row; flex-wrap: wrap; gap: 10px; }
      .filter-panel h2 { width: 100%; text-align: center; border: none; }
      .ilan-container { justify-content: center; }
      .ilan-card { width: 90%; max-width: 400px; }
    }
  </style>
</head>
<body>

  <!-- Filtre Paneli -->
  <div class="filter-panel" id="filterPanel">
    <h2 id="pageTitle">İlanlar</h2>

    <label for="il">İl</label>
    <select id="il">
      <option value="">Tümü</option>
      <option value="Antalya">Antalya</option>
      <option value="Konya">Konya</option>
      <option value="GaziAntep">GaziAntep</option>
    </select>

    <label for="ilce">İlçe</label>
    <select id="ilce">
      <option value="">Tümü</option>
    </select>

    <!-- Dinamik filtre alanları -->
    <div id="extraFilters"></div>

    <label for="fiyatMin">Minimum Fiyat</label>
    <input type="number" id="fiyatMin" placeholder="Min Fiyat">

    <label for="fiyatMax">Maksimum Fiyat</label>
    <input type="number" id="fiyatMax" placeholder="Max Fiyat">

    <button onclick="filtrele()">Uygula</button>
  </div>

  <!-- İlan Listesi -->
  <div class="ilan-container" id="ilanListesi"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://ofmupldxmqtgddzvbakp.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbXVwbGR4bXF0Z2RkenZiYWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MzU5OTksImV4cCI6MjA2OTIxMTk5OX0.TrMgsB37M12xT84UIvkIAzG285SpaKUjDAXn5GBMFsA";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // URL parametresinden ilan türü al
    const tur = new URLSearchParams(window.location.search).get('tur') || 'konut';

    const ilanListesi = document.getElementById("ilanListesi");
    const pageTitle = document.getElementById("pageTitle");
    pageTitle.textContent = tur + " İlanları";

    const ilceler = {
      Antalya: ["Akseki", "Alanya", "Finike", "Manavgat", "Konyaaltı"],
      Konya: ["Beyşehir", "Bozkır", "Seydişehir", "Meram", "Selçuklu"],
      GaziAntep: ["Şahinbey", "Şehitkamil", "Nizip", "Araban"]
    };

    document.getElementById("il").addEventListener("change", function () {
      const secilenIl = this.value;
      const ilceSelect = document.getElementById("ilce");
      ilceSelect.innerHTML = `<option value="">Tümü</option>`;
      if (ilceler[secilenIl]) {
        ilceler[secilenIl].forEach(ilce => {
          const opt = document.createElement("option");
          opt.value = ilce;
          opt.textContent = ilce;
          ilceSelect.appendChild(opt);
        });
      }
    });

    // Tür bazlı ek filtre alanları
    const extraFilters = document.getElementById("extraFilters");
    if (tur === "konut" || tur === "bina") {
      extraFilters.innerHTML = `
        <label for="odaSayisi">Oda Sayısı</label>
        <select id="odaSayisi">
          <option value="">Tümü</option>
          <option value="1+1">1+1</option>
          <option value="2+1">2+1</option>
          <option value="3+1">3+1</option>
          <option value="4+1">4+1</option>
        </select>
        <label for="metreMin">Minimum m²</label>
        <input type="number" id="metreMin" placeholder="Min m²">
        <label for="metreMax">Maksimum m²</label>
        <input type="number" id="metreMax" placeholder="Max m²">
      `;
    } else if (tur === "arsa") {
      extraFilters.innerHTML = `
        <label for="metreMin">Minimum m²</label>
        <input type="number" id="metreMin" placeholder="Min m²">
        <label for="metreMax">Maksimum m²</label>
        <input type="number" id="metreMax" placeholder="Max m²">
      `;
    } else {
      extraFilters.innerHTML = ``; // diğer türlerde ek filtre yok
    }

    let ilanlar = [];

    // İlanları getir
    async function ilanlariGetir() {
      const { data, error } = await supabaseClient
        .from("ilanlar")
        .select("*")
        .eq("ilan_turu", tur)
        .eq("onay_durumu", "onaylandi");

      if (error) {
        ilanListesi.innerHTML = `<p>Hata: ${error.message}</p>`;
        return;
      }

      ilanlar = data || [];
      renderIlanlar(ilanlar);
    }

    // İlanları listele
    function renderIlanlar(data) {
      ilanListesi.innerHTML = "";

      if (data.length === 0) {
        ilanListesi.innerHTML = "<p>İlan bulunamadı.</p>";
        return;
      }

      data.forEach(ilan => {
        // detaylar JSON parse
        let detay = ilan.detaylar || {};
        if (typeof detay === "string") {
          try { detay = JSON.parse(detay); } catch (e) { detay = {}; }
        }

        const odaSayisi = detay.odaSayisi || "-";
        const m2 = detay.m2Net || detay.m2Brut || "-";

        const div = document.createElement("div");
        div.className = "ilan-card";
        div.onclick = () => {
          window.location.href = `ilan-detay.html?id=${ilan.id}`;
        };

        div.innerHTML = `
          <img src="${ilan.resimler && ilan.resimler.length > 0 ? ilan.resimler[0] : 'https://via.placeholder.com/120'}" alt="${ilan.title}">
          <div class="ilan-info">
            <h3>${ilan.title}</h3>
            ${tur === "konut" || tur === "bina" ? `<p><strong>Oda Sayısı:</strong> ${odaSayisi}</p>` : ``}
            ${tur !== "arsa" ? `<p><strong>Metrekare:</strong> ${m2} m²</p>` : ``}
            <p><strong>Fiyat:</strong> ${ilan.price} TL</p>
          </div>
        `;
        ilanListesi.appendChild(div);
      });
    }

    // Filtreleme
    window.filtrele = function() {
      const il = document.getElementById("il").value;
      const ilce = document.getElementById("ilce").value;
      const fiyatMin = parseInt(document.getElementById("fiyatMin").value) || 0;
      const fiyatMax = parseInt(document.getElementById("fiyatMax").value) || Infinity;

      let oda = "";
      let metreMin = 0;
      let metreMax = Infinity;

      if (tur === "konut" || tur === "bina") {
        oda = document.getElementById("odaSayisi").value;
        metreMin = parseInt(document.getElementById("metreMin").value) || 0;
        metreMax = parseInt(document.getElementById("metreMax").value) || Infinity;
      } else if (tur === "arsa") {
        metreMin = parseInt(document.getElementById("metreMin").value) || 0;
        metreMax = parseInt(document.getElementById("metreMax").value) || Infinity;
      }

      const filtreli = ilanlar.filter(ilan => {
        const detay = typeof ilan.detaylar === "string" ? JSON.parse(ilan.detaylar) : ilan.detaylar || {};
        const odaMatch = oda ? detay.odaSayisi === oda : true;
        const metre = parseInt(detay.m2Net || detay.m2Brut || 0);
        const metreMatch = metre >= metreMin && metre <= metreMax;

        const ilMatch = il ? ilan.il === il : true;
        const ilceMatch = ilce ? ilan.ilce === ilce : true;
        const fiyatMatch = ilan.price >= fiyatMin && ilan.price <= fiyatMax;

        return ilMatch && ilceMatch && odaMatch && metreMatch && fiyatMatch;
      });

      renderIlanlar(filtreli);
    };

    ilanlariGetir();
  </script>

</body>
</html>
